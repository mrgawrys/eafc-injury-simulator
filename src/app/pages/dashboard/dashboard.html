@if (gameState()) {
  <div class="mb-6 flex items-center justify-between">
    <div class="flex items-center gap-4">
      @if (teamBadgeUrl()) {
        <img [src]="teamBadgeUrl()" [alt]="teamName()" class="h-12 w-12 object-contain" />
      }
      <div>
        <h2 class="text-2xl font-bold">{{ teamName() }}</h2>
        <p class="text-muted-foreground">
          Season Date: <strong>{{ currentDate() }}</strong>
          &middot; {{ availableCount() }} available &middot; {{ injuredCount() }} injured
        </p>
      </div>
    </div>
    <div class="flex gap-2">
      <button
        class="rounded-md bg-primary px-4 py-2 text-sm font-medium text-primary-foreground hover:bg-primary/90"
        (click)="openAdvanceDialog()"
      >
        Advance Time
      </button>
      @if (fatigueEnabled()) {
        <button
          class="rounded-md border px-4 py-2 text-sm font-medium hover:bg-accent"
          (click)="openEditSquad()"
        >
          Edit XI
        </button>
      }
      <a
        routerLink="/injury-log"
        class="rounded-md border px-4 py-2 text-sm font-medium hover:bg-accent"
      >
        Injury Log
      </a>
      <a
        routerLink="/"
        class="rounded-md border px-4 py-2 text-sm font-medium hover:bg-accent"
      >
        Home
      </a>
    </div>
  </div>

  <!-- Squad Table -->
  <div class="rounded-lg border">
    <table class="w-full text-sm">
      <thead>
        <tr class="border-b bg-muted/50">
          <th class="px-4 py-3 text-left font-medium select-none cursor-pointer" (click)="toggleSort('name')">
            Name{{ sortIndicator('name') }}
          </th>
          <th class="px-4 py-3 text-left font-medium select-none cursor-pointer" (click)="toggleSort('overall')">
            OVR{{ sortIndicator('overall') }}
          </th>
          <th class="px-4 py-3 text-left font-medium select-none cursor-pointer" (click)="toggleSort('position')">
            Position{{ sortIndicator('position') }}
          </th>
          <th class="px-4 py-3 text-left font-medium select-none cursor-pointer" (click)="toggleSort('age')">
            Age{{ sortIndicator('age') }}
          </th>
          <th class="px-4 py-3 text-left font-medium select-none cursor-pointer" (click)="toggleSort('status')">
            Status{{ sortIndicator('status') }}
          </th>
          <th class="px-4 py-3 text-left font-medium">Details</th>
          @if (fatigueEnabled()) {
            <th class="px-4 py-3 text-left font-medium">Fatigue</th>
          }
        </tr>
      </thead>
      <tbody>
        @for (player of sortedPlayers(); track player.name) {
          <tr class="border-b last:border-0">
            <td class="px-4 py-3 font-medium">
              <div class="flex items-center gap-2">
                <app-player-avatar [name]="player.name" [avatarUrl]="player.avatarUrl" size="sm" />
                {{ player.name }}
                @if (player.inSquad) {
                  <span class="inline-flex items-center rounded-full bg-primary/10 px-1.5 py-0.5 text-[10px] font-medium text-primary">
                    XI
                  </span>
                }
              </div>
            </td>
            <td class="px-4 py-3">
              @if (player.overall) {
                <span
                  class="inline-flex items-center rounded-full px-2 py-0.5 text-xs font-semibold"
                  [class]="player.overall >= 80 ? 'bg-green-100 text-green-800' : player.overall >= 70 ? 'bg-yellow-100 text-yellow-800' : 'bg-gray-100 text-gray-800'"
                >
                  {{ player.overall }}
                </span>
              } @else {
                <span class="text-muted-foreground">â€”</span>
              }
            </td>
            <td class="px-4 py-3">{{ player.position }}</td>
            <td class="px-4 py-3">{{ player.age }}</td>
            <td class="px-4 py-3">
              @switch (player.status) {
                @case ("available") {
                  <span class="inline-flex items-center rounded-full bg-green-100 px-2.5 py-0.5 text-xs font-medium text-green-800">
                    Available
                  </span>
                }
                @case ("returning-soon") {
                  <span class="inline-flex items-center rounded-full bg-yellow-100 px-2.5 py-0.5 text-xs font-medium text-yellow-800">
                    Returning Soon
                  </span>
                }
                @case ("injured") {
                  <span class="inline-flex items-center rounded-full bg-red-100 px-2.5 py-0.5 text-xs font-medium text-red-800">
                    Injured
                  </span>
                }
              }
            </td>
            <td class="px-4 py-3 text-muted-foreground">
              @if (player.injury) {
                {{ player.injury.type }} &middot; returns {{ player.injury.returnDate }}
              }
            </td>
            @if (fatigueEnabled()) {
              <td class="px-4 py-3">
                @switch (player.fatigueBadge) {
                  @case ('fresh') {
                    <span class="inline-flex items-center rounded-full bg-green-100 px-2.5 py-0.5 text-xs font-medium text-green-800">
                      Fresh
                    </span>
                  }
                  @case ('fatigued') {
                    <span class="inline-flex items-center rounded-full bg-orange-100 px-2.5 py-0.5 text-xs font-medium text-orange-800">
                      Fatigued
                    </span>
                  }
                  @case ('high-risk') {
                    <span class="inline-flex items-center rounded-full bg-red-100 px-2.5 py-0.5 text-xs font-medium text-red-800">
                      High Risk
                    </span>
                  }
                }
              </td>
            }
          </tr>
        }
      </tbody>
    </table>
  </div>

  <!-- Advance Time Dialog -->
  @if (showAdvanceDialog()) {
    <div class="fixed inset-0 z-50 flex items-center justify-center bg-black/50" (click)="closeDialog()">
      <div class="w-full max-w-md rounded-lg bg-background p-6 shadow-lg max-h-[80vh] overflow-y-auto" (click)="$event.stopPropagation()">

        @switch (advanceStep()) {
          @case ('squad') {
            <h3 class="text-lg font-semibold">Who Played?</h3>
            <p class="mt-1 text-sm text-muted-foreground">Tap to cycle: Starter &rarr; Sub &rarr; Rested</p>

            <div class="mt-4 space-y-1">
              @for (player of players(); track player.name) {
                @let playerId = teamName() + '__' + player.name;
                @let role = matchSquad()[playerId] ?? 'rested';
                <button
                  class="flex w-full items-center justify-between rounded-md px-3 py-2 text-sm transition-colors"
                  [class]="role === 'starter' ? 'bg-primary/10' : role === 'sub' ? 'bg-blue-50' : ''"
                  [disabled]="player.status === 'injured'"
                  (click)="cycleRole(playerId)"
                >
                  <span [class.text-muted-foreground]="player.status === 'injured'">
                    {{ player.name }}
                  </span>
                  <span class="text-xs font-medium"
                    [class]="role === 'starter' ? 'text-primary' : role === 'sub' ? 'text-blue-600' : 'text-muted-foreground'"
                  >
                    @if (player.status === 'injured') {
                      Injured
                    } @else {
                      {{ role === 'starter' ? 'Starter' : role === 'sub' ? 'Sub' : 'Rested' }}
                    }
                  </span>
                </button>
              }
            </div>

            <div class="mt-4 flex gap-2">
              <button
                class="rounded-md bg-primary px-4 py-2 text-sm font-medium text-primary-foreground hover:bg-primary/90"
                (click)="proceedToDate()"
              >
                Next
              </button>
              <button
                class="rounded-md border px-4 py-2 text-sm font-medium hover:bg-accent"
                (click)="closeDialog()"
              >
                Cancel
              </button>
            </div>
          }

          @case ('date') {
            <h3 class="text-lg font-semibold">Advance Time</h3>
            <div class="mt-4 space-y-4">
              <div>
                <label class="block text-sm font-medium">Advance to date</label>
                <input
                  type="date"
                  [min]="currentDate()"
                  [value]="targetDate()"
                  (input)="onDateInput($event)"
                  class="mt-1 w-full rounded-md border bg-background px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-ring"
                />
              </div>
              <div class="flex gap-2">
                <button
                  class="rounded-md bg-primary px-4 py-2 text-sm font-medium text-primary-foreground hover:bg-primary/90"
                  (click)="advanceTime()"
                >
                  Advance
                </button>
                <button
                  class="rounded-md border px-4 py-2 text-sm font-medium hover:bg-accent"
                  (click)="advanceToNextMatch()"
                >
                  Next Match (+3 days)
                </button>
              </div>
            </div>
          }

          @case ('result') {
            <h3 class="text-lg font-semibold">Results</h3>
            <div class="mt-4 space-y-3">
              <p class="text-sm text-muted-foreground">Advanced to <strong>{{ currentDate() }}</strong></p>

              @if (lastResult()!.newInjuries.length > 0) {
                <div>
                  <h4 class="text-sm font-semibold text-destructive">New Injuries</h4>
                  <ul class="mt-1 space-y-1 text-sm">
                    @for (inj of lastResult()!.newInjuries; track inj.playerId) {
                      <li class="flex items-center gap-3">
                        <app-player-avatar [name]="inj.playerName" [avatarUrl]="getPlayerAvatarUrl(inj.playerName)" size="lg" />
                        <div>
                          <span class="font-medium">{{ inj.playerName }}</span>
                          <span class="text-muted-foreground"> &mdash; {{ inj.type }} ({{ inj.daysMissed }} days)</span>
                        </div>
                      </li>
                    }
                  </ul>
                </div>
              } @else {
                <p class="text-sm text-green-600">No new injuries!</p>
              }

              @if (lastResult()!.recovered.length > 0) {
                <div>
                  <h4 class="text-sm font-semibold text-green-600">Recovered</h4>
                  <ul class="mt-1 space-y-1 text-sm">
                    @for (name of lastResult()!.recovered; track name) {
                      <li class="flex items-center gap-3">
                        <app-player-avatar [name]="name" [avatarUrl]="getPlayerAvatarUrl(name)" size="lg" />
                        {{ name }}
                      </li>
                    }
                  </ul>
                </div>
              }

              <button
                class="mt-2 rounded-md border px-4 py-2 text-sm font-medium hover:bg-accent"
                (click)="closeDialog()"
              >
                Close
              </button>
            </div>
          }
        }
      </div>
    </div>
  }
  <!-- Edit Starting XI Dialog -->
  @if (showEditSquad()) {
    <div class="fixed inset-0 z-50 flex items-center justify-center bg-black/50" (click)="showEditSquad.set(false)">
      <div class="w-full max-w-lg rounded-lg bg-background p-6 shadow-lg max-h-[80vh] overflow-y-auto" (click)="$event.stopPropagation()">
        <h3 class="text-lg font-semibold">Edit Starting XI</h3>
        <p class="mt-1 text-sm text-muted-foreground">
          {{ editSquadCount() }}/11 selected
        </p>

        <div class="mt-4 space-y-1">
          @for (player of players(); track player.name) {
            @let playerId = teamName() + '__' + player.name;
            <button
              class="flex w-full items-center justify-between rounded-md px-3 py-2 text-sm transition-colors"
              [class]="editingSquad().has(playerId) ? 'bg-primary/10 text-primary' : 'hover:bg-accent'"
              (click)="toggleEditSquadPlayer(playerId)"
            >
              <span>{{ player.name }}</span>
              <span class="text-xs text-muted-foreground">{{ player.position }}</span>
            </button>
          }
        </div>

        <div class="mt-4 flex gap-2">
          <button
            class="rounded-md bg-primary px-4 py-2 text-sm font-medium text-primary-foreground hover:bg-primary/90 disabled:opacity-50"
            [disabled]="editSquadCount() !== 11"
            (click)="saveEditSquad()"
          >
            Save
          </button>
          <button
            class="rounded-md border px-4 py-2 text-sm font-medium hover:bg-accent"
            (click)="showEditSquad.set(false)"
          >
            Cancel
          </button>
        </div>
      </div>
    </div>
  }
} @else {
  <p class="text-muted-foreground">Loading...</p>
}
